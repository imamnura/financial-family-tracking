// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN   // Kepala keluarga (ayah/ibu)
  MEMBER  // Anggota keluarga (pasangan/anak)
}

enum TransactionType {
  INCOME   // Pemasukan
  EXPENSE  // Pengeluaran
  TRANSFER // Transfer antar wallet
}

enum AssetType {
  PROPERTY    // Properti (rumah, tanah)
  VEHICLE     // Kendaraan
  SAVINGS     // Tabungan
  INVESTMENT  // Investasi
  OTHER       // Lainnya
}

enum LiabilityType {
  MORTGAGE       // KPR
  CAR_LOAN       // Kredit kendaraan
  CREDIT_CARD    // Kartu kredit
  PERSONAL_LOAN  // Pinjaman pribadi
  OTHER          // Lainnya
}

enum InviteStatus {
  PENDING   // Menunggu konfirmasi
  ACCEPTED  // Diterima
  REJECTED  // Ditolak
  EXPIRED   // Kadaluarsa
}

enum GoalStatus {
  ACTIVE      // Aktif
  COMPLETED   // Tercapai
  CANCELLED   // Dibatalkan
}

enum BudgetPeriod {
  MONTHLY  // Bulanan
  YEARLY   // Tahunan
}

enum RecurringFrequency {
  DAILY     // Harian
  WEEKLY    // Mingguan
  MONTHLY   // Bulanan
  YEARLY    // Tahunan
}

enum RecurringStatus {
  ACTIVE    // Aktif
  PAUSED    // Dijeda
  COMPLETED // Selesai
  CANCELLED // Dibatalkan
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // Hashed with bcrypt
  role      Role     @default(MEMBER)
  avatar    String?  // URL to avatar image
  
  // Relations
  familyId  String?
  family    Family?  @relation(fields: [familyId], references: [id], onDelete: SetNull)
  
  // User activity
  transactions          Transaction[]
  budgetCreated         Budget[]
  goalContributions     GoalContribution[]
  auditLogs             AuditLog[]
  recurringTransactions RecurringTransaction[]
  transactionTemplates  TransactionTemplate[]
  notifications         Notification[]
  reminderSchedules     ReminderSchedule[]
  emailLogs             EmailLog[]
  
  // Invitations
  invitesSent     FamilyInvite[] @relation("InviteSender")
  invitesReceived FamilyInvite[] @relation("InviteReceiver")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([email])
}

model Family {
  id          String   @id @default(cuid())
  name        String   // Nama keluarga, misal: "Keluarga Budi"
  description String?
  
  // Settings & Preferences
  currency         String  @default("IDR")        // Mata uang default
  timezone         String  @default("Asia/Jakarta") // Timezone
  language         String  @default("id")          // Bahasa (id/en)
  dateFormat       String  @default("DD/MM/YYYY")  // Format tanggal
  
  // Notification Preferences
  budgetAlerts     Boolean @default(true)   // Alert budget threshold
  goalReminders    Boolean @default(true)   // Reminder goal deadlines
  weeklyReport     Boolean @default(false)  // Laporan mingguan
  monthlyReport    Boolean @default(true)   // Laporan bulanan
  emailNotif       Boolean @default(true)   // Email notifications
  
  // Budget Settings
  defaultBudgetAlert Float? @default(80)    // Default alert threshold (%)
  
  // Relations
  members       User[]
  wallets       Wallet[]
  categories    Category[]
  transactions  Transaction[]
  assets        Asset[]
  liabilities   Liability[]
  invites       FamilyInvite[]
  goals         Goal[]
  budgets       Budget[]
  auditLogs     AuditLog[]
  recurringTransactions RecurringTransaction[]
  transactionTemplates  TransactionTemplate[]
  notifications         Notification[]
  reminderSchedules     ReminderSchedule[]
  emailLogs             EmailLog[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([name])
}

model Wallet {
  id          String  @id @default(cuid())
  name        String  // Nama wallet, misal: "BCA Ayah", "GoPay Ibu"
  type        String  // "BANK", "E_WALLET", "CASH"
  balance     Float   @default(0)
  description String?
  icon        String? // Icon identifier
  color       String? // Hex color untuk UI
  
  // Relations
  familyId     String
  family       Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  transactionsFrom  Transaction[] @relation("FromWallet")
  transactionsTo    Transaction[] @relation("ToWallet")
  
  recurringFrom RecurringTransaction[] @relation("RecurringFromWallet")
  recurringTo   RecurringTransaction[] @relation("RecurringToWallet")
  
  templateFrom  TransactionTemplate[] @relation("TemplateFromWallet")
  templateTo    TransactionTemplate[] @relation("TemplateToWallet")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
}

model Category {
  id          String  @id @default(cuid())
  name        String  // Nama kategori, misal: "Makanan", "Transport"
  type        TransactionType // INCOME or EXPENSE
  icon        String? // Icon identifier
  color       String? // Hex color untuk UI
  description String?
  
  // Relations
  familyId     String
  family       Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets      Budget[]
  recurringTransactions RecurringTransaction[]
  transactionTemplates  TransactionTemplate[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([familyId, name, type]) // Unique per family
  @@index([familyId])
}

model Transaction {
  id          String          @id @default(cuid())
  amount      Float
  type        TransactionType
  description String?
  notes       String?         // Catatan tambahan
  date        DateTime        @default(now()) // Tanggal transaksi
  
  // Relations
  familyId    String
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Untuk TRANSFER, gunakan fromWallet dan toWallet
  // Untuk INCOME/EXPENSE, gunakan fromWallet saja
  fromWalletId String?
  fromWallet   Wallet?  @relation("FromWallet", fields: [fromWalletId], references: [id], onDelete: SetNull)
  
  toWalletId   String?
  toWallet     Wallet?  @relation("ToWallet", fields: [toWalletId], references: [id], onDelete: SetNull)
  
  // Attachment/receipt image
  attachment  String?  // URL to receipt/proof
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([userId])
  @@index([categoryId])
  @@index([date])
  @@index([type])
}

model Asset {
  id              String    @id @default(cuid())
  name            String    // Nama aset, misal: "Rumah Jakarta"
  type            AssetType
  value           Float     // Nilai aset saat ini
  purchasePrice   Float?    // Harga beli awal
  description     String?
  acquisitionDate DateTime? // Tanggal perolehan
  depreciationRate Float?   // Persentase depresiasi per tahun (untuk VEHICLE, PROPERTY)
  
  // Relations
  familyId    String
  family      Family           @relation(fields: [familyId], references: [id], onDelete: Cascade)
  valueHistory AssetValueHistory[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([type])
}

model AssetValueHistory {
  id        String   @id @default(cuid())
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  value     Float    // Nilai aset pada waktu tertentu
  date      DateTime @default(now())
  notes     String?  // Catatan perubahan nilai
  source    String?  // Sumber valuasi (manual, market, appraisal)
  
  createdAt DateTime @default(now())
  
  @@index([assetId])
  @@index([date])
}

model Liability {
  id              String        @id @default(cuid())
  name            String        // Nama hutang, misal: "KPR Rumah"
  type            LiabilityType
  amount          Float         // Total hutang awal (renamed from totalAmount)
  remainingAmount Float         // Sisa hutang
  interestRate    Float?        // Bunga (%)
  creditor        String?       // Nama kreditor/pemberi pinjaman
  dueDate         DateTime?     // Jatuh tempo
  startDate       DateTime?     // Tanggal mulai
  monthlyPayment  Float?        // Angsuran bulanan
  term            Int?          // Jangka waktu (bulan)
  description     String?
  
  // Relations
  familyId    String
  family      Family           @relation(fields: [familyId], references: [id], onDelete: Cascade)
  payments    LiabilityPayment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([type])
  @@index([dueDate])
}

model LiabilityPayment {
  id            String     @id @default(cuid())
  liabilityId   String
  liability     Liability  @relation(fields: [liabilityId], references: [id], onDelete: Cascade)
  amount        Float      // Jumlah pembayaran
  principalPaid Float      // Pokok yang dibayar
  interestPaid  Float      // Bunga yang dibayar
  paymentDate   DateTime   @default(now())
  notes         String?
  paymentMethod String?    // Transfer, cash, etc
  
  createdAt DateTime @default(now())
  
  @@index([liabilityId])
  @@index([paymentDate])
}

model FamilyInvite {
  id        String       @id @default(cuid())
  email     String       // Email yang diundang
  token     String       @unique // Token unik untuk link undangan
  status    InviteStatus @default(PENDING)
  expiresAt DateTime     // Waktu kadaluarsa
  
  // Relations
  familyId  String
  family    Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  senderId  String
  sender    User   @relation("InviteSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId String?
  receiver   User?  @relation("InviteReceiver", fields: [receiverId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([email])
  @@index([token])
  @@index([status])
}

model Goal {
  id            String     @id @default(cuid())
  name          String     // Nama goal, misal: "Liburan Bali 2024"
  description   String?
  targetAmount  Float      // Target dana
  currentAmount Float      @default(0) // Dana terkumpul
  deadline      DateTime?  // Target waktu
  status        GoalStatus @default(ACTIVE)
  
  // Relations
  familyId      String
  family        Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  contributions GoalContribution[]
  distributions GoalDistribution[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([status])
}

model GoalContribution {
  id          String   @id @default(cuid())
  amount      Float
  description String?
  date        DateTime @default(now())
  
  // Relations
  goalId String
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([goalId])
  @@index([userId])
}

model GoalDistribution {
  id          String   @id @default(cuid())
  amount      Float
  description String?
  recipientEmail String // Email penerima
  recipientName  String // Nama penerima
  date        DateTime @default(now())
  
  // Relations
  goalId String
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([goalId])
}

model Budget {
  id          String       @id @default(cuid())
  name        String?      // Nama budget (optional)
  amount      Float        // Jumlah budget
  spent       Float        @default(0) // Sudah terpakai
  period      BudgetPeriod @default(MONTHLY)
  startDate   DateTime?    // Tanggal mulai (optional jika pakai month/year)
  endDate     DateTime?    // Tanggal akhir (optional jika pakai month/year)
  
  // Month/Year tracking (alternative to startDate/endDate)
  month       Int?         // 1-12 untuk tracking per bulan
  year        Int?         // YYYY untuk tracking per tahun
  
  // Alert settings
  alertThreshold Float? // Alert jika sudah mencapai % tertentu (misal: 80)
  
  // Relations
  familyId   String
  family     Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  createdById String
  createdBy   User    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([familyId, categoryId, month, year])
  @@index([familyId])
  @@index([categoryId])
  @@index([startDate, endDate])
  @@index([month, year])
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // "CREATE", "UPDATE", "DELETE"
  entityType  String   // "Transaction", "Asset", "Liability", dll
  entityId    String   // ID dari entity yang diubah
  dataBefore  String?  @db.Text // JSON string dari data sebelum perubahan
  dataAfter   String?  @db.Text // JSON string dari data setelah perubahan
  details     String?  @db.Text // JSON string untuk additional details
  changes     String?  @db.Text // JSON string untuk track changes
  ipAddress   String?
  userAgent   String?
  
  // Relations
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyId String?
  family   Family?  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([familyId])
  @@index([entityType])
  @@index([entityId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model RecurringTransaction {
  id          String              @id @default(cuid())
  name        String              // Nama recurring (misal: "Gaji Bulanan", "Tagihan Listrik")
  amount      Float
  type        TransactionType     // INCOME or EXPENSE
  description String?
  notes       String?
  
  // Scheduling
  frequency   RecurringFrequency  // DAILY, WEEKLY, MONTHLY, YEARLY
  startDate   DateTime            // Tanggal mulai
  endDate     DateTime?           // Tanggal berakhir (optional, null = unlimited)
  nextDate    DateTime            // Tanggal eksekusi berikutnya
  lastRunDate DateTime?           // Terakhir kali dijalankan
  
  // Optional: day of month (1-31) untuk MONTHLY
  dayOfMonth  Int?                // Untuk MONTHLY: tanggal berapa (1-31)
  
  // Optional: day of week (0-6) untuk WEEKLY
  dayOfWeek   Int?                // Untuk WEEKLY: 0=Sunday, 1=Monday, dst
  
  status      RecurringStatus     @default(ACTIVE)
  
  // Relations
  familyId    String
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  fromWalletId String?
  fromWallet   Wallet?  @relation("RecurringFromWallet", fields: [fromWalletId], references: [id], onDelete: SetNull)
  
  toWalletId   String?
  toWallet     Wallet?  @relation("RecurringToWallet", fields: [toWalletId], references: [id], onDelete: SetNull)
  
  createdById String
  createdBy   User    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([status])
  @@index([nextDate])
  @@index([createdById])
}

model TransactionTemplate {
  id          String          @id @default(cuid())
  name        String          // Nama template (misal: "Makan Siang Kantor")
  amount      Float?          // Jumlah (optional, bisa diisi saat pakai template)
  type        TransactionType
  description String?
  notes       String?
  
  // Relations
  familyId    String
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  fromWalletId String?
  fromWallet   Wallet?  @relation("TemplateFromWallet", fields: [fromWalletId], references: [id], onDelete: SetNull)
  
  toWalletId   String?
  toWallet     Wallet?  @relation("TemplateToWallet", fields: [toWalletId], references: [id], onDelete: SetNull)
  
  createdById String
  createdBy   User    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  // Usage tracking
  usageCount  Int      @default(0)  // Berapa kali template ini dipakai
  lastUsedAt  DateTime?             // Terakhir kali digunakan
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([createdById])
  @@index([usageCount])
}

// ============================================
// NOTIFICATION & REMINDER MODELS
// ============================================

enum NotificationType {
  DUE_DATE_REMINDER      // Pengingat jatuh tempo
  BUDGET_ALERT           // Alert budget (warning/exceeded)
  GOAL_MILESTONE         // Pencapaian goal
  PAYMENT_DUE            // Pembayaran jatuh tempo
  WEEKLY_SUMMARY         // Ringkasan mingguan
  MONTHLY_SUMMARY        // Ringkasan bulanan
  SYSTEM                 // Notifikasi sistem
}

enum NotificationStatus {
  PENDING    // Menunggu dikirim
  SENT       // Sudah dikirim
  FAILED     // Gagal
  READ       // Sudah dibaca
}

model Notification {
  id          String             @id @default(cuid())
  type        NotificationType
  status      NotificationStatus @default(PENDING)
  
  title       String
  message     String             @db.Text
  data        Json?              // Data tambahan (JSON)
  
  // Email tracking
  emailSent   Boolean            @default(false)
  emailSentAt DateTime?
  emailError  String?
  
  // Read status
  readAt      DateTime?
  
  // Relations
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  familyId    String
  family      Family             @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Reference (optional - untuk link ke entity terkait)
  referenceId   String?          // ID dari Budget/Goal/Liability/dll
  referenceType String?          // "budget", "goal", "liability", dll
  
  // Email logs
  emailLogs   EmailLog[]
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  
  @@index([userId, status])
  @@index([familyId])
  @@index([type])
  @@index([createdAt])
}

model ReminderSchedule {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  // Schedule settings
  enabled     Boolean  @default(true)
  frequency   String   // "daily", "weekly", "monthly", "custom"
  dayOfWeek   Int?     // 0-6 (Sunday-Saturday) untuk weekly
  dayOfMonth  Int?     // 1-31 untuk monthly
  time        String   // HH:mm format (misal: "09:00")
  
  // Notification settings
  notificationType NotificationType
  emailEnabled     Boolean @default(true)
  inAppEnabled     Boolean @default(true)
  
  // Custom criteria (JSON)
  criteria    Json?    // Kriteria khusus untuk reminder
  
  // Tracking
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  runCount    Int      @default(0)
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  familyId    String
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([familyId, enabled])
  @@index([userId])
  @@index([nextRunAt])
}

model EmailLog {
  id          String   @id @default(cuid())
  
  to          String
  subject     String
  body        String   @db.Text
  
  status      String   // "sent", "failed", "pending"
  error       String?  @db.Text
  
  // Metadata
  provider    String?  // "nodemailer", "sendgrid", dll
  messageId   String?
  
  // Relations
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  familyId    String?
  family      Family?  @relation(fields: [familyId], references: [id], onDelete: SetNull)
  
  notificationId String?
  notification   Notification? @relation(fields: [notificationId], references: [id], onDelete: SetNull)
  
  sentAt      DateTime?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([familyId])
  @@index([status])
  @@index([createdAt])
}


